<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--radius:14px;--shadow:0 6px 18px rgba(0,0,0,.12);--border:1px solid rgba(0,0,0,.08);--gap:14px;--maxw:1150px}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#fff;color:#111}
    .wrap{max-width:var(--maxw);margin:0 auto;padding:18px}
    .topbar{display:flex;gap:10px;align-items:center;margin-bottom:12px;flex-wrap:wrap}
    .search,.sel{padding:10px 12px;border-radius:10px;border:var(--border);outline:none;font-size:14px;background:#fff}
    .search{flex:1;min-width:240px}
    .sel{min-width:180px}
    .status{font-size:12px;opacity:.7;margin-left:auto}
    .hint{font-size:12px;opacity:.75;margin:10px 0 0;white-space:pre-wrap}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:var(--gap)}
    @media (max-width: 980px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width: 620px){.grid{grid-template-columns:1fr}}
    .card{border:var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;background:#fff;display:flex;flex-direction:column;min-height:320px;cursor:pointer}
    .img{width:100%;height:190px;background:#f3f4f6;overflow:hidden}
    .img img{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:12px 12px 14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title{font-size:16px;font-weight:800;line-height:1.2;margin:0}
    .meta{font-size:12px;opacity:.75;line-height:1.2}
    .desc{font-size:13px;line-height:1.35;opacity:.9;margin:0;display:-webkit-box;-webkit-line-clamp:4;-webkit-box-orient:vertical;overflow:hidden}
    .actions{margin-top:auto;display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;justify-content:center;align-items:center;padding:10px 12px;border-radius:10px;text-decoration:none;font-weight:700;font-size:13px;border:var(--border);background:#111;color:#fff;flex:1;text-align:center}
    .btn.secondary{background:#fff;color:#111}
    .filters{display:flex;gap:10px;flex-wrap:wrap;width:100%}

    /* ===== Modal detalle ===== */
    .modalBack{
      position:fixed; inset:0; background:rgba(0,0,0,.45);
      display:none; align-items:center; justify-content:center;
      padding:16px; z-index:9999;
    }
    .modal{
      width:min(920px, 100%); background:#fff; border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,.25); overflow:hidden;
      border:var(--border);
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 14px; border-bottom:var(--border);
      gap:10px;
    }
    .modalHeader h2{margin:0;font-size:16px;font-weight:900}
    .xbtn{
      border:var(--border); background:#fff; border-radius:10px;
      padding:8px 10px; cursor:pointer; font-weight:800;
    }
    .modalBody{display:grid; grid-template-columns: 1.2fr 1fr; gap:14px; padding:14px}
    @media (max-width: 820px){.modalBody{grid-template-columns:1fr}}
    .modalImg{background:#f3f4f6; border-radius:14px; overflow:hidden; border:var(--border); min-height:240px}
    .modalImg img{width:100%; height:100%; object-fit:cover; display:block}
    .kv{display:grid; grid-template-columns: 140px 1fr; gap:8px 10px; font-size:13px}
    .k{opacity:.65}
    .v{font-weight:650}
    .modalDesc{margin-top:10px; font-size:13px; line-height:1.4; white-space:pre-wrap}
    .modalActions{display:flex; gap:10px; margin-top:12px}
  </style>
</head>

<body>
  <div class="wrap" id="top">
    <div class="topbar">
      <input id="q" class="search" placeholder="Buscar (nombre, descripción, distrito, raza...)" />
      <div id="status" class="status"></div>
    </div>

    <div class="filters" aria-label="Filtros">
      <select id="f_tipo" class="sel"><option value="">Tipo: Todos</option></select>
      <select id="f_especie" class="sel"><option value="">Especie: Todas</option></select>
      <select id="f_tamano" class="sel"><option value="">Tamaño: Todos</option></select>
      <select id="f_depto" class="sel"><option value="">Departamento: Todos</option></select>
      <input id="f_raza" class="search" style="flex:0 1 240px;min-width:240px" placeholder="Raza (texto)" />
      <button id="clear" class="btn secondary" style="flex:0 0 auto">Limpiar filtros</button>
    </div>

    <div class="hint" id="hint"></div>
    <div style="height:14px"></div>
    <div id="grid" class="grid"></div>
  </div>

  <!-- ===== Modal detalle ===== -->
  <div id="modalBack" class="modalBack" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document">
      <div class="modalHeader">
        <h2 id="m_title">Detalle</h2>
        <button class="xbtn" id="m_close" aria-label="Cerrar">Cerrar</button>
      </div>
      <div class="modalBody">
        <div class="modalImg"><img id="m_img" alt="Imagen" /></div>
        <div>
          <div class="kv">
            <div class="k">Tipo</div><div class="v" id="m_tipo"></div>
            <div class="k">Especie</div><div class="v" id="m_especie"></div>
            <div class="k">Raza</div><div class="v" id="m_raza"></div>
            <div class="k">Tamaño</div><div class="v" id="m_tamano"></div>
            <div class="k">Ubicación</div><div class="v" id="m_ubi"></div>
            <div class="k">Fecha</div><div class="v" id="m_fecha"></div>
          </div>

          <div class="modalDesc" id="m_desc"></div>

          <div class="modalActions">
            <a class="btn" id="m_contact" target="_blank" rel="noopener">Contactar</a>
            <button class="btn secondary" id="m_close2">Volver</button>
          </div>

          <div class="hint" style="margin-top:10px">
            No mostramos teléfono ni correo. El contacto se hace vía WhatsApp.
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIGURA ESTO =========
    const SHEET_ID = "1fkxjf9tgQQ8ErVRaMSXZ6Jt6fR0_-EfnDjT99XJyJP4";
    const SHEET_NAME = "Publicaciones";
    // =================================

    const GVIZ_URL =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
      `sheet=${encodeURIComponent(SHEET_NAME)}` +
      `&tq=${encodeURIComponent("select *")}` +
      `&tqx=out:json` +
      `&_=${Date.now()}`;

    // ✅ IDX corregido según tus encabezados A..Q (0-index)
    const IDX = {
      tipoCaso: 2,       // C
      nombre: 3,         // D
      especie: 4,        // E
      raza: 5,           // F
      tamano: 6,         // G
      departamento: 7,   // H
      provincia: 8,      // I
      distrito: 9,       // J
      fecha: 10,         // K
      descripcion: 11,   // L
      telefono: 12,      // M
      imagen: 13,        // N
      aceptaDatos: 14,   // O
      activo: 15         // P
    };

    let activeRows = [];

    function sanitizeText(s){
      return String(s ?? "").replace(/[<>&"]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
    }
    function norm(s){ return String(s ?? "").trim().toLowerCase(); }
    function getCell(row, idx){
      const cell = row[idx];
      if (!cell) return "";
      return (cell.v ?? "");
    }
    function isActive(val){
      if (val === true) return true;
      const v = norm(val).replace(/\s+/g," ");
      return ["si","sí","true","1","activo","activa","yes","verdadero","ok","v","x"].includes(v);
    }
    function waLinkFromPhone(phone){
      const digits = String(phone ?? "").replace(/[^0-9]/g,"");
      if (!digits) return "";
      const full = digits.startsWith("51") ? digits : ("51"+digits);
      const msg = encodeURIComponent("Hola, vi tu publicación en Mascotas Perú y quiero ayudar.");
      return `https://wa.me/${full}?text=${msg}`;
    }

    // ====== Fotos: Drive -> URL directa ======
    function extractDriveId(url){
      const u = String(url || "").trim();
      if (!u) return "";
      const first = u.split(",")[0].trim(); // si vienen varias, usa la primera
      let m = first.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (m) return m[1];
      m = first.match(/[?&]id=([a-zA-Z0-9_-]+)/);
      if (m) return m[1];
      m = first.match(/\/uc\?.*id=([a-zA-Z0-9_-]+)/);
      if (m) return m[1];
      return "";
    }
    function normalizeImageUrl(url){
      const raw = String(url || "").trim();
      if (!raw) return "";
      if (/\.(png|jpg|jpeg|webp|gif)(\?|$)/i.test(raw)) return raw;
      const id = extractDriveId(raw);
      if (!id) return raw;
      return `https://drive.google.com/thumbnail?id=${id}&sz=w1200`;
    }

    function uniqSorted(values){
      return Array.from(new Set(values.map(v => String(v || "").trim()).filter(v => v !== "")))
        .sort((a,b) => String(a).localeCompare(String(b), "es", {sensitivity:"base"}));
    }
    function fillSelect(selectEl, values){
      const first = selectEl.querySelector("option");
      const current = selectEl.value;
      selectEl.innerHTML = "";
      selectEl.appendChild(first);
      for (const v of values){
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      }
      if (current && values.includes(current)) selectEl.value = current;
    }

    function render(list){
      const grid = document.getElementById("grid");
      grid.innerHTML = "";

      list.forEach((r) => {
        const foto = r.imagen || "";
        const nombre = sanitizeText(r.nombre || "Sin nombre");
        const desc = sanitizeText(r.descripcion || "");
        const meta = sanitizeText([r.tipoCaso, r.especie, r.tamano, r.raza, r.distrito, r.departamento].filter(Boolean).join(" • "));
        const link = r.whatsapp || "";

        const card = document.createElement("div");
        card.className = "card";

        const imgHtml = foto
          ? `<img loading="lazy" src="${foto}" alt="${nombre}"
               onerror="this.style.display='none'; this.closest('.img').style.background='#e5e7eb';">`
          : "";

        card.innerHTML = `
          <div class="img">${imgHtml}</div>
          <div class="content">
            <h3 class="title">${nombre}</h3>
            <div class="meta">${meta}</div>
            <p class="desc">${desc}</p>
            <div class="actions">
              ${link ? `<a class="btn contactBtn" href="${link}" target="_blank" rel="noopener">Contactar</a>` : `<span class="btn secondary" style="pointer-events:none;opacity:.6;">Sin contacto</span>`}
              <span class="btn secondary" style="pointer-events:none;">Ver</span>
            </div>
          </div>
        `;

        // Click en tarjeta => abre detalle (pero si clickeas "Contactar", NO abre)
        card.addEventListener("click", (ev) => {
          if (ev.target && ev.target.classList && ev.target.classList.contains("contactBtn")) return;
          openModal(r);
        });

        grid.appendChild(card);
      });

      document.getElementById("status").textContent = `${list.length} publicaciones activas`;
    }

    function applyFilters(){
      const q = norm(document.getElementById("q").value);
      const fTipo = document.getElementById("f_tipo").value;
      const fEsp = document.getElementById("f_especie").value;
      const fTam = document.getElementById("f_tamano").value;
      const fDep = document.getElementById("f_depto").value;
      const fRaza = norm(document.getElementById("f_raza").value);

      const filtered = activeRows.filter(r => {
        if (fTipo && r.tipoCaso !== fTipo) return false;
        if (fEsp && r.especie !== fEsp) return false;
        if (fTam && r.tamano !== fTam) return false;
        if (fDep && r.departamento !== fDep) return false;
        if (fRaza && !norm(r.raza).includes(fRaza)) return false;

        if (q){
          const hay = norm(`${r.nombre} ${r.descripcion} ${r.departamento} ${r.provincia} ${r.distrito} ${r.tipoCaso} ${r.especie} ${r.raza} ${r.tamano}`);
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      render(filtered);
    }

    function clearFilters(){
      document.getElementById("q").value = "";
      document.getElementById("f_tipo").value = "";
      document.getElementById("f_especie").value = "";
      document.getElementById("f_tamano").value = "";
      document.getElementById("f_depto").value = "";
      document.getElementById("f_raza").value = "";
      applyFilters();
    }

    function parseGviz(text){
      const start = text.indexOf("{");
      const end = text.lastIndexOf("}");
      if (start < 0 || end < 0) return null;
      return JSON.parse(text.substring(start, end + 1));
    }

    // ===== Modal =====
    const modalBack = document.getElementById("modalBack");
    const closeBtns = [document.getElementById("m_close"), document.getElementById("m_close2")];

    function openModal(r){
      document.getElementById("m_title").textContent = r.nombre || "Detalle";

      const img = document.getElementById("m_img");
      if (r.imagen){
        img.src = r.imagen;
        img.style.display = "block";
      } else {
        img.removeAttribute("src");
        img.style.display = "none";
      }

      document.getElementById("m_tipo").textContent = r.tipoCaso || "-";
      document.getElementById("m_especie").textContent = r.especie || "-";
      document.getElementById("m_raza").textContent = r.raza || "-";
      document.getElementById("m_tamano").textContent = r.tamano || "-";

      const ubic = [r.departamento, r.provincia, r.distrito].filter(Boolean).join(" / ");
      document.getElementById("m_ubi").textContent = ubic || "-";

      document.getElementById("m_fecha").textContent = r.fechaHecho || "-";
      document.getElementById("m_desc").textContent = r.descripcion || "";

      const contact = document.getElementById("m_contact");
      if (r.whatsapp){
        contact.style.display = "inline-flex";
        contact.href = r.whatsapp;
      } else {
        contact.style.display = "none";
        contact.removeAttribute("href");
      }

      modalBack.style.display = "flex";
      modalBack.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeModal(){
      modalBack.style.display = "none";
      modalBack.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    closeBtns.forEach(b => b.addEventListener("click", closeModal));
    modalBack.addEventListener("click", (e) => { if (e.target === modalBack) closeModal(); });
    window.addEventListener("keydown", (e) => { if (e.key === "Escape") closeModal(); });

    async function load(){
      const hint = document.getElementById("hint");
      document.getElementById("status").textContent = "Cargando...";
      hint.textContent = "";

      try{
        const res = await fetch(GVIZ_URL, { cache: "no-store" });
        const text = await res.text();
        const json = parseGviz(text);

        if (!json || !json.table){
          hint.textContent =
            "No llegó JSON válido desde Google Sheets.\n" +
            "Causa típica: permisos (sheet no público) o abrir como file://.\n\n" +
            "Respuesta (primeros 200 chars):\n" + text.slice(0,200);
          document.getElementById("status").textContent = "Error leyendo la hoja";
          return;
        }

        const table = json.table;
        const data = table.rows.map(r => r.c.map(c => c || null));

        const allRows = data.map(row => {
          const tel = getCell(row, IDX.telefono);
          const imgRaw = getCell(row, IDX.imagen);

          return {
            tipoCaso: getCell(row, IDX.tipoCaso),
            nombre: getCell(row, IDX.nombre),
            especie: getCell(row, IDX.especie),
            raza: getCell(row, IDX.raza),
            tamano: getCell(row, IDX.tamano),
            departamento: getCell(row, IDX.departamento),
            provincia: getCell(row, IDX.provincia),
            distrito: getCell(row, IDX.distrito),
            fechaHecho: getCell(row, IDX.fecha),
            descripcion: getCell(row, IDX.descripcion),
            imagen: normalizeImageUrl(imgRaw),
            whatsapp: waLinkFromPhone(tel),
            activo: getCell(row, IDX.activo),
          };
        }).filter(r => r.nombre || r.descripcion || r.imagen);

        activeRows = allRows.filter(r => isActive(r.activo));

        fillSelect(document.getElementById("f_tipo"),   uniqSorted(activeRows.map(r => r.tipoCaso)));
        fillSelect(document.getElementById("f_especie"),uniqSorted(activeRows.map(r => r.especie)));
        fillSelect(document.getElementById("f_tamano"), uniqSorted(activeRows.map(r => r.tamano)));
        fillSelect(document.getElementById("f_depto"),  uniqSorted(activeRows.map(r => r.departamento)));

        ["q","f_tipo","f_especie","f_tamano","f_depto","f_raza"].forEach(id => {
          document.getElementById(id).addEventListener("input", applyFilters);
          document.getElementById(id).addEventListener("change", applyFilters);
        });
        document.getElementById("clear").addEventListener("click", clearFilters);

        render(activeRows);

        hint.textContent = activeRows.length
          ? "OK: mostrando solo casos activos."
          : "Cargó la hoja, pero no hay filas activas según Caso Activo.";

      } catch (e){
        document.getElementById("status").textContent = "Error cargando datos.";
        document.getElementById("hint").textContent =
          "Fallo de red/permiso.\n" +
          "1) Sheet público (cualquiera con enlace: lector)\n" +
          "2) Abrir por https (GitHub Pages / Live Server), no file://\n\n" +
          "Detalle: " + String(e);
        console.error(e);
      }
    }

    document.getElementById("clear").addEventListener("click", clearFilters);
    load();
  </script>
</body>
</html>
